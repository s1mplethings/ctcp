{
  "id": "S23_lite_robust_idempotent_outbox_no_duplicates",
  "name": "lite robust: repeated advance should not duplicate same outbox prompt",
  "suite": "lite",
  "steps": [
    {
      "run": {
        "cmd": "python scripts/ctcp_orchestrate.py new-run --goal simlab-robust-idempotent-outbox > artifacts/_s23_newrun.out.txt 2>&1",
        "expect_exit": 0
      }
    },
    {
      "run": {
        "cmd": "python -c \"from pathlib import Path; import json; rd=Path('meta/run_pointers/LAST_RUN.txt').read_text(encoding='utf-8').strip(); r=Path(rd); art=r/'artifacts'; art.mkdir(parents=True, exist_ok=True); cfg={'schema_version':'ctcp-dispatch-config-v1','mode':'manual_outbox','role_providers':{'librarian':'manual_outbox','chair':'manual_outbox','contract_guardian':'manual_outbox','cost_controller':'manual_outbox','patchmaker':'manual_outbox','fixer':'manual_outbox','researcher':'manual_outbox'},'budgets':{'max_outbox_prompts':20}}; (art/'dispatch_config.json').write_text(json.dumps(cfg, ensure_ascii=False, indent=2)+'\\n', encoding='utf-8'); (art/'guardrails.md').write_text('find_mode: resolver_only\\nmax_files: 5\\nmax_total_bytes: 20000\\nmax_iterations: 2\\n', encoding='utf-8'); (art/'analysis.md').write_text('# analysis\\n', encoding='utf-8'); idx=json.loads(Path('workflow_registry/index.json').read_text(encoding='utf-8')); wf=''; rp=idx.get('resolver_policy',{}) if isinstance(idx,dict) else {}; wf=str(rp.get('fallback_workflow_id','')).strip() if isinstance(rp,dict) else ''; ws=idx.get('workflows',[]) if isinstance(idx,dict) else []; first=ws[0] if isinstance(ws,list) and ws else {}; wf=wf or (str(first.get('id') or first.get('workflow_id') or '').strip() if isinstance(first,dict) else ''); wf=wf or 'wf_orchestrator_only'; find={'schema_version':'ctcp-find-result-v1','selected_workflow_id':wf,'selected_version':'1.0','candidates':[{'workflow_id':wf,'version':'1.0','score':1.0,'why':'simlab'}]}; (art/'find_result.json').write_text(json.dumps(find, ensure_ascii=False, indent=2)+'\\n', encoding='utf-8'); req={'schema_version':'ctcp-file-request-v1','goal':'simlab-robust-idempotent-outbox','needs':[{'path':'README.md','mode':'full'}],'budget':{'max_files':1,'max_total_bytes':3000},'reason':'simlab'}; (art/'file_request.json').write_text(json.dumps(req, ensure_ascii=False, indent=2)+'\\n', encoding='utf-8')\"",
        "expect_exit": 0
      }
    },
    {
      "run": {
        "cmd": "python -c \"import subprocess,sys; rc=subprocess.call('python scripts/ctcp_orchestrate.py advance --max-steps 8', shell=True); print(rc); sys.exit(0)\"",
        "expect_exit": 0
      }
    },
    {
      "run": {
        "cmd": "python -c \"from collections import Counter; from pathlib import Path; import json; rd=Path('meta/run_pointers/LAST_RUN.txt').read_text(encoding='utf-8').strip(); outbox=Path(rd)/'outbox'; rows=[]; [rows.append((lambda lines: ((next((ln.split(':',1)[1].strip().lower() for ln in lines if ln.lower().startswith('role:')), ''), next((ln.split(':',1)[1].strip().lower() for ln in lines if ln.lower().startswith('target-path:') or ln.lower().startswith('write to:')), ''))))(p.read_text(encoding='utf-8').splitlines())) for p in sorted(outbox.glob('*.md'))]; keys=[f'{r}|{t}' for (r,t) in rows if r and t]; before=dict(Counter(keys)); Path('artifacts/_s23_before.json').write_text(json.dumps(before, ensure_ascii=False, indent=2)+'\\n', encoding='utf-8')\"",
        "expect_exit": 0
      }
    },
    {
      "run": {
        "cmd": "python -c \"import subprocess,sys; rc=subprocess.call('python scripts/ctcp_orchestrate.py advance --max-steps 8', shell=True); print(rc); sys.exit(0)\"",
        "expect_exit": 0
      }
    },
    {
      "run": {
        "cmd": "python -c \"from collections import Counter; from pathlib import Path; import json; before=json.loads(Path('artifacts/_s23_before.json').read_text(encoding='utf-8')); rd=Path('meta/run_pointers/LAST_RUN.txt').read_text(encoding='utf-8').strip(); outbox=Path(rd)/'outbox'; rows=[]; [rows.append((lambda lines: ((next((ln.split(':',1)[1].strip().lower() for ln in lines if ln.lower().startswith('role:')), ''), next((ln.split(':',1)[1].strip().lower() for ln in lines if ln.lower().startswith('target-path:') or ln.lower().startswith('write to:')), ''))))(p.read_text(encoding='utf-8').splitlines())) for p in sorted(outbox.glob('*.md'))]; keys=[f'{r}|{t}' for (r,t) in rows if r and t]; after=dict(Counter(keys)); assert all(after.get(k,0)==v for k,v in before.items()), f'before={before}, after={after}'; key='librarian|artifacts/context_pack.json'; assert before.get(key,0)>=1, f'missing key in before: {before}'; assert after.get(key,0)>=1, f'missing key in after: {after}'; Path('artifacts/_s23_outbox_counts.txt').write_text(json.dumps({'before':before,'after':after}, ensure_ascii=False, indent=2)+'\\n', encoding='utf-8')\"",
        "expect_exit": 0
      }
    },
    {
      "expect_text": {
        "path": "artifacts/_s23_outbox_counts.txt",
        "includes": [
          "librarian|artifacts/context_pack.json"
        ]
      }
    }
  ]
}
