name: gate-matrix

on:
  push:
    branches: ["**"]
  pull_request:

jobs:
  preflight-and-matrix:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install Python deps
        run: |
          python -m pip install --upgrade pip
          python -m pip install pytest pytest-qt

      - name: Preflight
        shell: pwsh
        run: |
          "suite_gate_exists=$([bool](Test-Path 'tools/checks/suite_gate.py'))"
          "live_suite_exists=$([bool](Test-Path 'tests/fixtures/adlc_forge_full_bundle/suites/forge_full_suite.live.yaml'))"
          if (Get-Command cmake -ErrorAction SilentlyContinue) { "cmake=present" } else { "cmake=missing" }
          python -c "import importlib.util;print('pytest_qt=present' if importlib.util.find_spec('pytestqt') else 'pytest_qt=missing')"
          if ($env:DISPLAY) { "display=present" } else { "display=missing" }

      - name: Run Gate Matrix
        run: |
          python tools/checks/gate_matrix_runner.py

      - name: Upload reports
        uses: actions/upload-artifact@v4
        with:
          name: gate-matrix-reports
          path: |
            tests/fixtures/adlc_forge_full_bundle/runs/_suite_eval_summary.json
            tests/fixtures/adlc_forge_full_bundle/runs/ISSUE_DIAGNOSIS.md
            tests/fixtures/adlc_forge_full_bundle/runs/ISSUE_REPORT_DETAILED.md
